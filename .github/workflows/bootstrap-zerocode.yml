name: Bootstrap Zerocode App

on:
  workflow_dispatch:
    inputs:
      app_dir:
        description: Directory name for the app
        default: zerocode-app
        required: true
      branch:
        description: Branch name to push
        default: bootstrap/zerocode-app
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, sqlite3
          coverage: none

      - name: Verify tools
        run: |
          php -v
          composer -V
          sqlite3 --version

      - name: Create Laravel app
        run: |
          APP_DIR='${{ github.event.inputs.app_dir }}'
          BRANCH='${{ github.event.inputs.branch }}'
          if [ -d "$APP_DIR" ]; then
            echo "App dir already exists; exiting to avoid overwriting" && exit 1
          fi
          composer create-project --prefer-dist laravel/laravel "$APP_DIR"
          cd "$APP_DIR"
          composer require livewire/livewire laravel/sanctum spatie/laravel-permission spatie/laravel-activitylog --no-interaction

          # SQLite setup
          mkdir -p database
          touch database/database.sqlite
          cp .env .env.example.local || true
          sed -i 's/^DB_CONNECTION=.*/DB_CONNECTION=sqlite/' .env
          sed -i '/^DB_HOST/d;/^DB_PORT/d;/^DB_DATABASE=.*/d;/^DB_USERNAME/d;/^DB_PASSWORD/d' .env
          php artisan key:generate

          # Sanctum publish (optional guards)
          php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider" --tag=config --force || true

          # Permission (publish config/migrations)
          php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --force || true

          # Activitylog publish
          php artisan vendor:publish --provider="Spatie\Activitylog\ActivitylogServiceProvider" --tag="activitylog-migrations" --force || true
          php artisan vendor:publish --provider="Spatie\Activitylog\ActivitylogServiceProvider" --tag="activitylog-config" --force || true

          # Basic migration
          php artisan migrate --force

          # Add Bootstrap CDN to default layout
          cat > resources/views/layouts/app.blade.php <<'BLADE'
          <!doctype html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>{{ config('app.name', 'Zerocode') }}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet" integrity="sha384-56vS7K6v2r2mFqZ3bKx6f9lP0z8oJ2lWwD2tJvX8n8W6U2k5kN1UO1wO2u6Q3ZfS" crossorigin="anonymous">
            @livewireStyles
          </head>
          <body>
            <div class="container py-4">
              @yield('content')
            </div>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-+5Z1pQrUqjvQe1hV+1yLqXo5b6bWJvprQwU3rQz2m2cSl/4Z6qzQn9zM0fQw1j2J4" crossorigin="anonymous"></script>
            @livewireScripts
          </body>
          </html>
          BLADE

      - name: Commit and push
        run: |
          APP_DIR='${{ github.event.inputs.app_dir }}'
          BRANCH='${{ github.event.inputs.branch }}'
          git config user.name "zerocode-bot"
          git config user.email "bot@example.com"
          git checkout -b "$BRANCH"
          git add "$APP_DIR"
          git commit -m "feat(zerocode): bootstrap Laravel+Livewire+SQLite app (no Docker)"
          git push -u origin "$BRANCH"

      - name: Open PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.inputs.branch }}
          title: "feat(zerocode): bootstrap Laravel+Livewire+SQLite app (no Docker)"
          body: "Automated bootstrap of the Zerocode app without Docker. Includes Livewire, Sanctum, Permission, Activitylog, and SQLite configuration."
          base: ${{ github.ref_name }}